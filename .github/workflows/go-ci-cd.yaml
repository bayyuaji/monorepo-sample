name: Go Service CI/CD

on:
  push:
    branches: [ main ]
    paths:
      - "apps/go-service/**"

env:
  DOCKERHUB_NAMESPACE: bayyuaji
  GO_APP_VERSION: "1.0.0"
  K8S_NAMESPACE: "go-app"      

jobs:
  go-ci-cd:
    name: Test, Build, Deploy Go Service
    runs-on: [self-hosted, k8s-runner]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------- TEST ----------
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Run Go tests
        working-directory: apps/go-service
        run: go test ./...

      # ---------- BUILD ----------
      - name: Docker login to Docker Hub
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login \
            -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Build Go image
        run: |
          GO_IMAGE="${DOCKERHUB_NAMESPACE}/monorepo:go-${GO_APP_VERSION}"
          echo "Building image ${GO_IMAGE}"
          docker build \
            -f apps/go-service/Dockerfile \
            -t "${GO_IMAGE}" \
            apps/go-service

      - name: Push Go image
        run: |
          GO_IMAGE="${DOCKERHUB_NAMESPACE}/monorepo:go-${GO_APP_VERSION}"
          docker push "${GO_IMAGE}"

      # ---------- DEPLOY ----------
      - name: Ensure kubectl installed
        run: |
          if ! command -v kubectl >/dev/null 2>&1; then
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            chmod +x kubectl
            mv kubectl /usr/local/bin/kubectl
          else
            echo "kubectl already installed"
          fi

      - name: Ensure kustomize installed
        run: |
          if ! command -v kustomize >/dev/null 2>&1; then
            curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh"  | bash
            mv kustomize /usr/local/bin/kustomize
          else
            echo "kustomize already installed"
          fi

      - name: Check current Kubernetes context
        run: |
          kubectl config current-context || echo "No current context"
          kubectl get nodes

      - name: Apply Go service overlay (ci-cd)
        run: |
          if [ -d "k8s/go-service/overlays/ci-cd" ]; then
            kustomize build k8s/go-service/overlays/ci-cd | kubectl apply -f -
          else
            echo "Go ci-cd overlay not found, skipping"
          fi

      - name: Update Go deployment image to latest tag
        run: |
          GO_IMAGE="${DOCKERHUB_NAMESPACE}/monorepo:go-${GO_APP_VERSION}"
          echo "Updating go-service image to ${GO_IMAGE}"
          kubectl -n "${K8S_NAMESPACE}" set image deployment/go-service \
            go-service="${GO_IMAGE}" \
            --record

      - name: Wait for Go deployment rollout
        run: |
          kubectl -n "${K8S_NAMESPACE}" rollout status deployment/go-service

